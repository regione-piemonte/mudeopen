<title-bar title="Ricerca Fascicoli"></title-bar>

<div class="narrowed-box">
  <div class="card-box">
    <ng-container
      *ngTemplateOutlet="
        ricercaFascicoliFields;
        context: { formgroup: ricercaFascicoliForm }
      "
    ></ng-container>
  </div>
</div>

<ng-template #ricercaFascicoliFields let-formgroup="formgroup">
  <form
    id="formFascicoli"
    #searchForm
    [formGroup]="formgroup"
    *ngIf="formgroup"
    (ngSubmit)="onSearch()"
  >
    <div class="row">
      <!-- first col -->
      <div class="form-group col px-4">
        <title-section subtitle="Intestatario"></title-section>
        <div class="mb-2 ml-2">
          <div class="">Nome, cognome o CF</div>
        </div>
        <div class="searchCol pb-3">
          <input
            type="search"
            id="id_intestatario_pf"
            class="form-control"
            formControlName="id_intestatario_pf"
            placeholder=""
          />
        </div>

        <div class="my-2 ml-2">
          <div class="">Ragione sociale o P.IVA</div>
        </div>
        <div class="searchCol pb-3">
          <input
            type="search"
            id="id_intestatario_pg"
            class="form-control"
            formControlName="id_intestatario_pg"
            placeholder=""
          />
        </div>

        <title-section subtitle="Professionista di Riferimento"></title-section>
        <div class="mb-2 ml-2">
          <div class="">Nome, cognome o CF</div>
        </div>
        <div class="searchCol pb-3">
          <input
            type="search"
            id="id_pm"
            class="form-control"
            formControlName="id_pm"
            placeholder=""
          />
        </div>
      </div>

      <!-- second col -->
      <div class="form-group col">
        <title-section subtitle="Ubicazione"></title-section>
        <div class="searchCol" formGroupName="id_provincia">
          <it-select
            [emptyOption]="''"
            controlName="id"
            [parentFormGroup]="formgroup"
            (valueChangedEvent)="onChangeProvincia($event)"
            label="Provincia"
            [data]="provincePiemonte"
          >
          </it-select>
        </div>
        <div class="searchCol pt-2 comuni-column" formGroupName="id_comune">
          <it-select
            [emptyOption]="''"
            label="Comune"
            [parentFormGroup]="formgroup"
            [data]="comuni"
            controlName="id"
          >
          </it-select>
        </div>
        <div class="searchCol pt-2">
          <div class="row">
            <div class="col-4 pr-0 mr-0 dug-column" formGroupName="id_dug">
              <it-select
                [emptyOption]="''"
                [data]="dug"
                [parentFormGroup]="formgroup"
                label="Indirizzo"
                controlName="id"
              >
              </it-select>
            </div>
            <div class="col-8 ml-0 pl-1 duf-column">
              <it-input
                label="&nbsp;"
                [parentFormGroup]="formgroup"
                controlName="duf"
                placeholder=""
              ></it-input>
            </div>
          </div>
        </div>
      </div>

      <!-- third col -->
      <div class="form-group col">
        <title-section subtitle="Periodo temporale"></title-section>
        <div class="maxColWidth row mb-0">
          <div class="col ml-2">Da</div>
          <div class="col mr-2">A</div>
        </div>
        <div class="ml-2 d-flex pb-3">
          <div class="">
            <it-datepicker
              [parentFormGroup]="formgroup"
              controlName="data_creazione_from"
              label=""
              small="true"
            ></it-datepicker>
          </div>
          <div class="ml-2">
            <it-datepicker
              [parentFormGroup]="formgroup"
              controlName="data_creazione_to"
              label=""
              small="true"
            ></it-datepicker>
          </div>
        </div>

        <title-section subtitle="Stato"></title-section>
        <div class="searchCol" formGroupName="stato">
          <it-select
            [emptyOption]="''"
            [parentFormGroup]="formgroup"
            controlName="id"
            [data]="statoFascicoloList"
            label=""
          >
          </it-select>
        </div>
        <div class="my-3">
          <alert-box
            *ngIf="wrongDateInterval"
            type="WARNING"
            message="L'Intervallo di date specificato non è corretto"
            timeout="5000"
          ></alert-box>
        </div>
      </div>
    </div>

    <title-section subtitle="">Ricerca per numero fascicolo</title-section>
    <div class="col-md-6 mb-5 px-2">
      <it-input
        [parentFormGroup]="formgroup"
        controlName="codice_fascicolo"
        label=""
        placeholder=""
      >
      </it-input>
    </div>
    <ng-container *ngTemplateOutlet="formToolbar"></ng-container>
  </form>
</ng-template>

<ng-template #formToolbar let-formgroup="formgroup">
  <div class="d-flex mt-4 mb-4 mx-2">
    <div class="">
      <button class="btn btn-outline-fixed-slim">CERCA</button>
    </div>
    <div class="ml-auto">
      <button type="reset" class="linkedText" (click)="clean()">NUOVA RICERCA</button>
    </div>
  </div>
</ng-template>

<!--Filtri veloci-->
<title-section subtitle="Filtri veloci"></title-section>
<div>
  <div>
    <button
      *ngFor="let el of this.statiFiltro | keyvalue"
      form="formFascicoli"
      class="btn btn-rounded btn-outline-fixed-slim mr-3 btn-color-slim blue"
      type="submit"
      (click)="filtriVeloci(el.key)" >
      {{ el.value }}
    </button>
  </div>
</div>

<app-mude-table
  *ngIf="isSubmitted"
  [rows]="rows"
  [rowIdentity]="rowIdentity"
  [rowDetail]="istancesDetailRow"
  [rowExpanded]="rowExpanded"
  [datatable]="datatable"
  [columns]="columnsFascicoli"
  (pageChanged)="onSearch($event)"
>
</app-mude-table>

<div class="button-container">
  <span class="button-group" *ngIf="isSubmitted"
    ><button
      type="button"
      id="downloadExcel"
      (click)="downloadExcel()"
      class="btn btn-primary btn-m"
    >
      Scarica Excel
    </button>
  </span>
</div>

<ng-template #actionsTemplate let-row="row">
  {{ row }}
</ng-template>

<ng-template
  #expandRowTemplate
  let-row="row"
  let-expanded="expanded"
  ngx-datatable-cell-template
>
  <a
    class="expand-link"
    href="javascript:void(0)"
    (click)="toggleExpandRow(row, expanded)"
    ><img alt="" src="assets/images/dots.png" class="plusIcon" />
  </a>
</ng-template>

<ng-template #istancesDetailRow let-row="row" let-expanded="expanded">
  <table *ngIf="row._istanzeFascicoloList?.length" class="tbl-width table-istanza">
    <caption>Lista fascicoli</caption>
    <tr>
      <th scope="col" class="dr-col5 detail-row-cell">Azioni</th>
      <th scope="col" class="dr-col1 detail-row-cell">Numero istanza</th>
      <th scope="col" class="dr-col1 detail-row-cell">Numero pratica</th>
      <th scope="col" class="dr-col3 detail-row-cell">Tipo istanza</th>
      <th scope="col" class="dr-col1 detail-row-cell">Intestatario</th>

      <th scope="col" class="dr-col1 detail-row-cell">Indirizzo</th>
      <th scope="col" class="dr-col1 detail-row-cell">Data Ricezione</th>
      <th scope="col" class="dr-col4 detail-row-cell">Stato</th>
      <th scope="col" class="dr-col1 detail-row-cell">Data Stato</th>
      <th scope="col" class="dr-col1 detail-row-cell">
        Occupazione suolo pubblico
      </th>
      <th scope="col" class="dr-col2 detail-row-cell">Comune</th>
    </tr>
    <ng-container
      *ngFor="let istanza of row._istanzeFascicoloList; let i = index"
    >
      <ng-container
        *ngTemplateOutlet="istanzaRow; context: { istanza: istanza, i: i }"
      ></ng-container>
    </ng-container>

    <ng-template #istanzaRow let-istanza="istanza" let-i="i">
      <tr class="istanza-fascicolo-row{{ i % 2 }}">
        <td class="dr-col5 detail-row-cell pb-3 pl-2">
          <a
            *appNgHasPermissionsOnIstance="[
              Permission.CONSULTA_IST,
              istanza.funzioniUtente
            ]"
            class="expand-link"
            href="javascript:void(0)"
            (click)="navigateToDetailInstance(istanza.id_istanza)"
            ><img alt="" src="assets/images/doc.png" class="plusIcon" />
          </a>
        </td>

        <td class="dr-col1 detail-row-cell">{{ istanza.codice_istanza }}</td>
        <td class="dr-col1 detail-row-cell">{{ istanza?.numero_pratica }}</td>
        <td class="dr-col1 detail-row-cell">
          {{ istanza.tipologia_istanza.value }} - {{ istanza.specie_pratica?.value ? istanza.specie_pratica?.value : ''}}
        </td>
        <td class="dr-col1 detail-row-cell">
          {{ istanza?.fascicolo?.intestatario.anagrafica?.nome }}

          {{
            istanza?.fascicolo?.intestatario.anagrafica?.cognome
              ? istanza?.fascicolo?.intestatario.anagrafica?.cognome
              : istanza?.fascicolo?.intestatario.anagrafica?.ragioneSociale
          }}
        </td>
        <td class="dr-col2 detail-row-cell">
          {{ istanza.indirizzo?.dug?.value }} {{ istanza.indirizzo?.duf }}
          {{ istanza.indirizzo?.numero }} (
          {{ istanza.indirizzo?.provincia?.value }}
          {{ istanza.indirizzo?.cap }} )
        </td>
        <td class="dr-col2 detail-row-cell">
          {{ istanza.data_stato_dps }}
        </td>
        <td class="dr-col3 detail-row-cell">
          {{ istanza.stato_istanza.value }}
        </td>
        <td class="dr-col3 detail-row-cell">{{ istanza.data_creazione }}</td>

        <td class="dr-col3 detail-row-cell">
          {{ istanza.occupazione_suolo_pubblico ? 'Sì' : 'No' }}
        </td>
        <td class="dr-col2 detail-row-cell">{{ istanza.comune.value }}</td>

      </tr>
      <ng-container
        *ngFor="let figlia of istanza._istanzeFiglie; let i = index"
      >
        <ng-container
          *ngTemplateOutlet="istanzaRow; context: { istanza: figlia, i: i }"
        ></ng-container>
      </ng-container>
    </ng-template>
    <div class="button-container">
      <span class="button-group"
        ><button
          type="button"
          id="downloadExcelIstanze"
          class="btn btn-primary btn-sm"
          (click)="downloadExcelIstanze(row)"
        >
          Scarica Excel
        </button>
      </span>
    </div>
  </table>
</ng-template>
